import serde

export log_event = |event|
  serialized = serde.to_json(event)
  host.log_info serialized
  serialized

export make_counter = ||
  count: 0
  log: |event| log_event event
  increment: |amount = 1|
    self.log { action: 'increment', amount, before: self.count }
    self.count += amount
    self.log { action: 'incremented', total: self.count }
    self.count
  reset: ||
    self.log { action: 'reset' }
    self.count = 0
    self.log { action: 'reset-complete', total: self.count }
    self.count
  snapshot: || { total: self.count }

counter = make_counter()

log_event { action: 'script-start', total: counter.count }

counter.reset()
counter.increment()
counter.increment(2)

summary = counter.snapshot()
log_event { action: 'script-complete', total: summary.total }

"Counter ready with total {summary.total}. Open the Tests tab to validate the behaviour."
